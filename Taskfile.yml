# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

vars:
  GREETING: Hello, world!

tasks:
  default:
    desc: Print a greeting message
    cmds:
      - echo "{{.GREETING}}"
    silent: true

  redis:
    desc: "Start Redis container"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redisU

  run:
    desc: "Run local server"
    cmds:
      - uv run uvicorn src.main:app 2>&1 | tee logs/server.log
  build:
    desc: "Build frontend"
    cmds:
      - cd frontend && npm run build

  dev:
    desc: "Run frontend dev server"
    cmds:
      - cd frontend && npm run dev

  read:
    desc: "Run local server"
    cmds:
      - gcloud run services logs read paperterrace --limit=1000

  tail:
    desc: "Run local server"
    cmds:
      - gcloud beta run services logs tail paperterrace

  get_iam:
    desc: "Get IAM policy"
    cmds:
      - gcloud run services get-iam-policy paperterrace

  add_all_users:
    desc: "Add auth"
    cmds:
      - gcloud run services add-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  remove_all_users:
    desc: "Remove IAM policy"
    cmds:
      - gcloud run services remove-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  db:stop:
    desc: Stop Cloud SQL instance (save cost)
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER

  db:start:
    desc: Start Cloud SQL instance
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS

  all_stop:
    desc: Stop all services
    deps: [remove_all_users, db:stop]

  deploy:
    desc: start:build deploy
    cmds:
      - ./deploy.sh

  db:wait:
    desc: Wait for Cloud SQL to be RUNNABLE
    cmds:
      - |
        echo "Waiting for Cloud SQL to be RUNNABLE..."
        for i in 1 2 3 4 5 6; do
          STATUS=$(gcloud sql instances describe paperterrace-db \
            --format="value(state)")
          echo "Current state: $STATUS"
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "Cloud SQL is ready"
            exit 0
          fi
          sleep 30
        done
        echo "Cloud SQL did not become RUNNABLE"
        exit 1

  start:
    desc: start db and deploy
    deps:
      - db:start
      - db:wait
      - deploy

  ruff:
    desc: "Run ruff"
    cmds:
      - uv run ruff check --fix .

  chche_clear:
    desc: "Clear cache"
    cmds:
      - sqlite3 ocr_reader.db "DELETE FROM ocr_reader;"
