# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

dotenv: ["local-files/secrets/.env"]

vars:
  PROJECT_ID: '{{.PROJECT_ID | default "gen-lang-client-0800253336"}}'
  REGION: '{{.REGION | default "asia-northeast1"}}'
  REGISTRY: '{{.REGISTRY | default "192.168.10.123:5000"}}'
  ENV: '{{.ENV | default "main"}}'
  NAMESPACE: '{{if eq .ENV "main"}}paperterrace{{else}}paperterrace-{{.ENV}}{{end}}'
  RELEASE_NAME: '{{if eq .ENV "main"}}paperterrace{{else}}paperterrace-{{.ENV}}{{end}}'

  # Resource Configurations from JSON
  BE_CPU:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["backend"]["cpu"])''',
    }
  BE_MEM:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["backend"]["memory"])''',
    }
  BE_STG_CPU:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["backend_staging"]["cpu"])''',
    }
  BE_STG_MEM:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["backend_staging"]["memory"])''',
    }

  INF_CPU:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference"]["cpu"])''',
    }
  INF_MEM:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference"]["memory"])''',
    }
  INF_STG_CPU:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference_staging"]["cpu"])''',
    }
  INF_STG_MEM:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference_staging"]["memory"])''',
    }
  INF_STG_WORKERS:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference_staging"].get("batch_parallel_workers", 2))''',
    }

  INF_WORKERS:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["inference"].get("batch_parallel_workers", 2))''',
    }

  BUILD_MACHINE:
    {
      sh: 'python3 -c ''import json; print(json.load(open("config/resources.json"))["build"]["machine_type"])''',
    }

tasks:
  # ============================================================================
  # Development Tasks
  # ============================================================================

  default:
    desc: "Show available tasks"
    cmds:
      - task --list
    silent: true

  setup:
    desc: "Setup development environment"
    cmds:
      - echo "üîß Setting up development environment..."
      - task: redis
      - echo "‚úÖ Development environment ready!"

  redis:
    desc: "Start Redis container for local development"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redis

  run:
    desc: "Run backend server with hot reload"
    cmds:
      - mkdir -p local-files/logs
      - PYTHONUNBUFFERED=1 uv run --directory backend env PYTHONPATH=.:.. uvicorn app.main:app --reload --host 0.0.0.0 --port 8080 | tee -a local-files/logs/local.log

  dev:
    desc: "Run frontend dev server"
    cmds:
      - npm run dev
    dir: frontend

  dev:full:
    desc: "Run both backend and frontend in parallel"
    deps: [redis]
    cmds:
      - echo "üöÄ Starting full development environment..."
      - |
        # Start backend in background
        PYTHONUNBUFFERED=1 uv run --directory backend env PYTHONPATH=.:.. uvicorn app.main:app --reload --host 0.0.0.0 --port 8080 &
        BACKEND_PID=$!

        # Start frontend in background  
        cd frontend && npm run dev &
        FRONTEND_PID=$!

        echo "Backend PID: $BACKEND_PID"
        echo "Frontend PID: $FRONTEND_PID"
        echo "Press Ctrl+C to stop both services"

        # Wait for interrupt
        trap "kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; exit" INT
        wait

  build:
    desc: "Build frontend for production"
    cmds:
      - npm run build
    dir: frontend

  test:backend:
    desc: "Run backend tests"
    cmds:
      - uv run --directory backend env PYTHONPATH=.:.. pytest -n auto || [ $? -eq 5 ]

  test:inference:
    desc: "Run inference service tests"
    cmds:
      - uv run --directory inference-service env PYTHONPATH=.:.. pytest -n auto || [ $? -eq 5 ]

  test:redis:
    desc: "Run redis provider tests"
    cmds:
      - uv run --directory redis_provider env PYTHONPATH=.:.. pytest || [ $? -eq 5 ]

  test:frontend:
    desc: "Run frontend tests (Vitest)"
    cmds:
      - cd frontend && npm run test || [ $? -eq 1 ]

  test:
    desc: "Run affected tests for all components (Optimized)"
    cmds:
      - task: test:backend
      - task: test:inference
      - task: test:redis
      - task: test:frontend

  test:all:
    desc: "Run all tests for all components"
    cmds:
      - uv run --directory backend env PYTHONPATH=.:.. pytest -n auto
      - uv run --directory inference-service env PYTHONPATH=.:.. pytest -n auto
      - uv run --directory redis_provider env PYTHONPATH=.:.. pytest
      - cd frontend && npm run test

  lint:
    desc: "Run linting and formatting for all components"
    cmds:
      - echo "üîç Running biome check..."
      - npx biome check --write frontend/ common/ redis_provider/
      - echo "üîç Running backend linting..."
      - uv run --directory backend ruff check --fix .
      - echo "üîç Running inference-service linting..."
      - uv run --directory inference-service ruff check --fix .
      - echo "üîç Running common & shared linting..."
      - uv run --directory backend ruff check --fix ../common
      - uv run --directory redis_provider ruff check --fix .
      - echo "üîç Running frontend linting..."
      - cd frontend && npm run lint

  clean:
    desc: "Clean cache and temporary files"
    cmds:
      - echo "üßπ Cleaning cache..."
      - rm -rf backend/.ruff_cache backend/__pycache__ backend/app/__pycache__
      - rm -rf frontend/node_modules/.cache frontend/dist
      - sqlite3 ocr_reader.db "DELETE FROM ocr_reader;" 2>/dev/null || true
      - rm -rf backend/app/static/paper_images/* 2>/dev/null || true
      - rm -rf local-files/logs/*.log
      - echo "‚úÖ Cache cleared!"

  # ============================================================================
  # Production Tasks
  # ============================================================================

  # ============================================================================
  # Database Tasks
  # ============================================================================

  db:start:
    desc: "Start Cloud SQL instance"
    cmds:
      - echo "üîÑ Starting Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS
      - task: db:wait

  db:stop:
    desc: "Stop Cloud SQL instance (save cost)"
    cmds:
      - echo "‚èπÔ∏è Stopping Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER

  db:wait:
    desc: "Wait for Cloud SQL to be ready"
    cmds:
      - |
        echo "‚è≥ Waiting for Cloud SQL to be RUNNABLE..."
        for i in {1..6}; do
          STATUS=$(gcloud sql instances describe paperterrace-db --format="value(state)")
          echo "Current state: $STATUS"
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "‚úÖ Cloud SQL is ready"
            exit 0
          fi
          sleep 30
        done
        echo "‚ùå Cloud SQL did not become RUNNABLE"
        exit 1

  db:migrate:
    desc: "Run database migrations"
    cmds:
      - echo "üîÑ Running database migrations..."
      - uv run --directory backend alembic upgrade head

  # ============================================================================
  # Staging Environment Tasks
  # ============================================================================

  # ============================================================================
  # Infrastructure Tasks
  # ============================================================================

  # ============================================================================
  # Infrastructure Tasks
  # ============================================================================

  infra:init:production:
    desc: "Initialize Terraform for production"
    cmds:
      - echo "üîß Initializing Terraform for production..."
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform init

  infra:import:production:
    desc: "Import existing GCP resources into Terraform state (production)"
    cmds:
      - echo "üì• Importing existing resources to Terraform..."
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform import -var="project_id={{.PROJECT_ID}}" -var="region={{.REGION}}" -var="gemini_api_key=${GEMINI_API_KEY}" -var="db_password=${DB_PASSWORD}" -var="image_url={{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest" module.artifact_registry.google_artifact_registry_repository.main projects/{{.PROJECT_ID}}/locations/{{.REGION}}/repositories/paperterrace || echo "‚ö†Ô∏è Already imported or not found"
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform import -var="project_id={{.PROJECT_ID}}" -var="region={{.REGION}}" -var="gemini_api_key=${GEMINI_API_KEY}" -var="db_password=${DB_PASSWORD}" -var="image_url={{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest" module.iam.google_service_account.app_sa projects/{{.PROJECT_ID}}/serviceAccounts/paperterrace-sa@{{.PROJECT_ID}}.iam.gserviceaccount.com || echo "‚ö†Ô∏è Already imported or not found"
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform import -var="project_id={{.PROJECT_ID}}" -var="region={{.REGION}}" -var="gemini_api_key=${GEMINI_API_KEY}" -var="db_password=${DB_PASSWORD}" -var="image_url={{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest" module.networking.google_compute_network.main projects/{{.PROJECT_ID}}/global/networks/paperterrace-vpc || echo "‚ö†Ô∏è Already imported or not found"
      - echo "‚úÖ Import complete!"

  infra:plan:production:
    desc: "Plan Terraform changes for production"
    cmds:
      - echo "üìã Planning Terraform changes for production..."
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform plan -var="project_id={{.PROJECT_ID}}" -var="region={{.REGION}}" -var="gemini_api_key=${GEMINI_API_KEY}" -var="db_password=${DB_PASSWORD}" -var="image_url={{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest"

  infra:apply:production:
    desc: "Apply Terraform changes for production"
    cmds:
      - echo "üöÄ Applying Terraform changes for production..."
      - unset GOOGLE_APPLICATION_CREDENTIALS && cd local-files/infrastructure/environments/production && terraform apply -var="project_id={{.PROJECT_ID}}" -var="region={{.REGION}}" -var="gemini_api_key=${GEMINI_API_KEY}" -var="db_password=${DB_PASSWORD}" -var="image_url={{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest"

  # ============================================================================
  # Utility Tasks
  # ============================================================================

  cleanup:
    desc: "Clean up unused Docker images and containers"
    cmds:
      - echo "üßπ Cleaning up Docker resources..."
      - docker system prune -f
      - echo "‚úÖ Docker cleanup complete!"

  # ============================================================================
  # Helm Deployment Tasks
  # ============================================================================

  helm:lint:
    desc: "Lint Helm chart"
    cmds:
      - helm lint ./local-files/infrastructure/helm/paperterrace

  # ============================================================================
  # Home Server (k3s) Deployment Tasks
  # ============================================================================

  k3s:secrets:
    desc: "Setup K8s secrets on home server"
    cmds:
      - ./local-files/scripts/create-secrets.sh {{.ENV}}

  k3s:status:
    desc: "Show status of k3s resources"
    cmds:
      - kubectl get pods,svc,deploy -n {{.NAMESPACE}}

  k3s:logs:backend:
    desc: "View backend logs in k3s"
    cmds:
      - kubectl logs -f -l app=backend -n {{.NAMESPACE}}

  k3s:logs:inference:
    desc: "View inference logs in k3s"
    cmds:
      - kubectl logs -f -l app=inference -n {{.NAMESPACE}}

  k3s:restart:backend:
    desc: "Restart backend in k3s"
    cmds:
      - kubectl rollout restart deployment/backend -n {{.NAMESPACE}}

  k3s:restart:inference:
    desc: "Restart inference server in k3s"
    cmds:
      - kubectl rollout restart deployment/inference -n {{.NAMESPACE}}

  k3s:restart:all:
    desc: "Restart all application services in k3s"
    cmds:
      - task: k3s:restart:backend
      - task: k3s:restart:inference

  k3s:health:
    desc: "Check health of services in k3s"
    cmds:
      - echo "üîç Checking service health in {{.NAMESPACE}}..."
      - |
        echo "Backend:"
        kubectl exec -n {{.NAMESPACE}} deployment/backend -- curl -s http://localhost:8080/api/health || \
        kubectl exec -n {{.NAMESPACE}} deployment/backend -- python3 -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8080/api/health').read().decode())" || \
        echo "‚ùå Unhealthy"
        echo ""
        echo "Inference Server:"
        kubectl exec -n {{.NAMESPACE}} deployment/inference -- curl -s http://localhost:8080/health || \
        kubectl exec -n {{.NAMESPACE}} deployment/inference -- python3 -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8080/health').read().decode())" || \
        echo "‚ùå Unhealthy"
        echo ""
        echo "Redis:"
        kubectl exec -n {{.NAMESPACE}} statefulset/{{.RELEASE_NAME}}-redis-master -- redis-cli ping || echo "‚ùå Unhealthy"

  homeserver:health:
    desc: "Check health of all services"
    cmds:
      - task: k3s:health

  homeserver:build:
    desc: "Build Docker images for home server"
    env:
      REGISTRY: "{{.REGISTRY}}"
    cmds:
      - ./local-files/scripts/build-images.sh

  homeserver:ps:
    desc: "Show status of all services"
    cmds:
      - task: k3s:status

  # ============================================================================
  # Cloudflare Deployment Tasks
  # ============================================================================

  cf:tunnel:setup:
    desc: "Setup Cloudflare Tunnel"
    cmds:
      - ./local-files/scripts/setup-tunnel.sh

  cf:tunnel:start:
    desc: "Start Cloudflare Tunnel (k3s)"
    cmds:
      - kubectl scale deployment/cloudflared --replicas=1 -n {{.NAMESPACE}}

  cf:tunnel:logs:
    desc: "View Cloudflare Tunnel logs (k3s)"
    cmds:
      - kubectl logs -f -l app=cloudflared -n {{.NAMESPACE}}

  cf:workers:install:
    desc: "Install all dependencies (including Workers/Frontend)"
    cmds:
      - npm install

  cf:workers:deploy:
    desc: "Deploy Cloudflare Workers"
    cmds:
      - cd cloudflare-workers && npx wrangler deploy --env {{.ENV}}

  cf:pages:deploy:
    desc: "Deploy frontend to Cloudflare Pages"
    cmds:
      - echo "Building frontend for {{.ENV}}..."
      - npm run build -w frontend
      - echo "Deploying to Cloudflare Pages branch {{if eq .ENV "main"}}main{{else}}dev{{end}}..."
      - npx wrangler pages deploy frontend/dist --project-name paperterrace --branch {{if eq .ENV "main"}}main{{else}}dev{{end}}

  cf:deploy:all:
    desc: "Deploy both Workers and Pages"
    cmds:
      - task: cf:workers:deploy
      - task: cf:pages:deploy

  cf:workers:secrets:
    desc: "Configure Cloudflare Workers secrets"
    cmds:
      - echo "Setting up Cloudflare Workers secrets for {{.ENV}}..."
      - echo "Run these commands manually:"
      - echo "  npx wrangler secret put FIREBASE_PROJECT_ID --env {{.ENV}}"
      - echo "  npx wrangler secret put FIREBASE_CLIENT_EMAIL --env {{.ENV}}"
      - echo "  npx wrangler secret put FIREBASE_PRIVATE_KEY --env {{.ENV}}"

  # ============================================================================
  # Migration Tasks
  # ============================================================================

  migrate:prepare:
    desc: "Prepare for migration to home server"
    cmds:
      - echo "üìã Migration preparation checklist:"
      - echo "1. ‚úì Ensure .env file is configured"
      - echo "2. ‚úì Ensure service account key is in local-files/secrets/sa-key.json"
      - echo "3. ‚úì Ensure models are downloaded to ./models/"
      - echo "4. ‚úì Ensure Cloudflare Tunnel is set up"
      - echo "5. ‚úì Test home server deployment"
      - echo "6. ‚úì Test Cloudflare Workers deployment"
      - echo "7. ‚úì Verify end-to-end flow"

  migrate:test:
    desc: "Test new architecture"
    cmds:
      - echo "üß™ Testing new architecture..."
      - task: k3s:health
      - echo "Testing API Gateway..."
      - echo "Manual test required -- Visit Cloudflare Workers URL with valid token"

  migrate:switch:
    desc: "Switch traffic to new architecture"
    cmds:
      - echo "‚ö†Ô∏è  This will switch traffic to the new architecture"
      - echo "Make sure you have tested thoroughly!"
      - echo "Update DNS to point to Cloudflare Pages"
      - echo "Monitor logs and metrics closely"
