# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

dotenv: [".env"]

vars:
  PROJECT_ID: gen-lang-client-0800253336
  REGION: asia-northeast1

tasks:
  # ============================================================================
  # Development Tasks
  # ============================================================================

  default:
    desc: "Show available tasks"
    cmds:
      - task --list
    silent: true

  setup:
    desc: "Setup development environment"
    cmds:
      - echo "ðŸ”§ Setting up development environment..."
      - task: redis
      - echo "âœ… Development environment ready!"

  redis:
    desc: "Start Redis container for local development"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redis

  run:
    desc: "Run backend server with hot reload"
    cmds:
      - mkdir -p logs
      - PYTHONUNBUFFERED=1 uv run --directory backend env PYTHONPATH=.:.. uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 | tee -a logs/local.log

  dev:
    desc: "Run frontend dev server"
    cmds:
      - npm run dev
    dir: frontend

  dev:full:
    desc: "Run both backend and frontend in parallel"
    deps: [redis]
    cmds:
      - echo "ðŸš€ Starting full development environment..."
      - |
        # Start backend in background
        PYTHONUNBUFFERED=1 uv run --directory backend env PYTHONPATH=.:.. uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &
        BACKEND_PID=$!

        # Start frontend in background  
        cd frontend && npm run dev &
        FRONTEND_PID=$!

        echo "Backend PID: $BACKEND_PID"
        echo "Frontend PID: $FRONTEND_PID"
        echo "Press Ctrl+C to stop both services"

        # Wait for interrupt
        trap "kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; exit" INT
        wait

  build:
    desc: "Build frontend for production"
    cmds:
      - npm run build
    dir: frontend

  test:
    desc: "Run backend tests"
    cmds:
      - uv run --directory backend pytest

  lint:
    desc: "Run linting and formatting"
    cmds:
      - echo "ðŸ” Running backend linting..."
      - uv run --directory backend ruff check --fix .
      - echo "ðŸ” Running frontend linting..."
      - cd frontend && npm run lint

  clean:
    desc: "Clean cache and temporary files"
    cmds:
      - echo "ðŸ§¹ Cleaning cache..."
      - rm -rf backend/.ruff_cache backend/__pycache__ backend/app/__pycache__
      - rm -rf frontend/node_modules/.cache frontend/dist
      - sqlite3 ocr_reader.db "DELETE FROM ocr_reader;" 2>/dev/null || true
      - rm -rf backend/app/static/paper_images/* 2>/dev/null || true
      - rm -rf logs/*.log
      - echo "âœ… Cache cleared!"

  # ============================================================================
  # Production Tasks
  # ============================================================================

  deploy:
    desc: "Deploy to production"
    cmds:
      - echo "ðŸš€ Deploying to production..."
      - ./scripts/deployment/deploy.sh

  deploy:fast:
    desc: "Fast deploy (skip infrastructure checks)"
    cmds:
      - ./scripts/deployment/deploy.sh --skip-infra

  # ============================================================================
  # Database Tasks
  # ============================================================================

  db:start:
    desc: "Start Cloud SQL instance"
    cmds:
      - echo "ðŸ”„ Starting Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS
      - task: db:wait

  db:stop:
    desc: "Stop Cloud SQL instance (save cost)"
    cmds:
      - echo "â¹ï¸ Stopping Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER

  db:wait:
    desc: "Wait for Cloud SQL to be ready"
    cmds:
      - |
        echo "â³ Waiting for Cloud SQL to be RUNNABLE..."
        for i in {1..6}; do
          STATUS=$(gcloud sql instances describe paperterrace-db --format="value(state)")
          echo "Current state: $STATUS"
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "âœ… Cloud SQL is ready"
            exit 0
          fi
          sleep 30
        done
        echo "âŒ Cloud SQL did not become RUNNABLE"
        exit 1

  db:migrate:
    desc: "Run database migrations"
    cmds:
      - echo "ðŸ”„ Running database migrations..."
      - uv run --directory backend alembic upgrade head

  # ============================================================================
  # Staging Environment Tasks
  # ============================================================================

  staging:deploy:servicea:
    desc: "Deploy backend to staging environment"
    cmds:
      - echo "ðŸš€ Deploying backend to staging..."
      - gcloud auth configure-docker {{.REGION}}-docker.pkg.dev --quiet
      - docker build --platform linux/amd64 -f backend/Dockerfile -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging .
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null || echo "")
        if [ -z "$SERVICEB_URL" ]; then
          echo "âš ï¸ ServiceB not found. Deploy inference service first with: task staging:deploy:serviceb"
          SERVICEB_URL="https://paperterrace-inference-staging-placeholder.run.app"
        fi

        gcloud run deploy paperterrace-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging \
          --region {{.REGION}} \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 2 \
          --min-instances 0 \
          --max-instances 20 \
          --concurrency 80 \
          --timeout 300 \
          --set-env-vars "GEMINI_API_KEY=${GEMINI_API_KEY},AI_PROVIDER=gemini,OCR_MODEL=gemini-1.5-flash,LOG_LEVEL=INFO,ACCESS_LOG_LEVEL=INFO,INFERENCE_SERVICE_URL=$SERVICEB_URL,INFERENCE_SERVICE_TIMEOUT=30,SKIP_INFERENCE_SERVICE_WARMUP=false,STORAGE_TYPE=gcs,GCS_BUCKET_NAME=paperterrace-papers"
      - echo "âœ… Backend deployed to staging!"
      - task: staging:urls

  staging:deploy:serviceb:
    desc: "Deploy inference service to staging"
    cmds:
      - echo "ðŸ”¨ Building and deploying inference service..."
      - gcloud auth configure-docker {{.REGION}}-docker.pkg.dev --quiet
      - docker build --platform linux/amd64 -f inference-service/Dockerfile -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging .
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging
      - |
        gcloud run deploy paperterrace-inference-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging \
          --region {{.REGION}} \
          --allow-unauthenticated \
          --memory 4Gi \
          --cpu 4 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 10 \
          --timeout 300 \
          --set-env-vars "LOG_LEVEL=INFO,DEV_MODE=false,SKIP_MODEL_LOADING=false,LOCAL_MODEL_PATH=/app/models/m2m100_ct2,TRANSLATION_BEAM_SIZE=5,TRANSLATION_REPETITION_PENALTY=1.4,TRANSLATION_NO_REPEAT_NGRAM_SIZE=3"
      - echo "âœ… Inference service deployed to staging!"
      - task: staging:urls

  staging:deploy:
    desc: "Deploy both backend and inference to staging"
    cmds:
      - echo "ðŸš€ Deploying all services to staging..."
      - task: staging:deploy:serviceb
      - echo "â³ Waiting 10 seconds for inference service to be ready..."
      - sleep 10
      - task: staging:deploy:servicea
      - echo "ðŸŽ‰ All services deployed to staging!"

  staging:test:
    desc: "Run comprehensive staging tests"
    cmds:
      - echo "ðŸ§ª Running staging tests..."
      - task: staging:health
      - task: staging:test:translation
      - echo "âœ… All staging tests passed!"

  staging:test:translation:
    desc: "Test translation functionality"
    cmds:
      - echo "ðŸ”¤ Testing translation..."
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -z "$SERVICEB_URL" ]; then
          echo "âŒ Inference service not found. Deploy first with: task staging:deploy:serviceb"
          exit 1
        fi

        echo "Testing translation endpoint: $SERVICEB_URL/api/v1/translate"

        RESPONSE=$(curl -s -X POST "$SERVICEB_URL/api/v1/translate" \
          -H "Content-Type: application/json" \
          -d '{"text": "Hello world",  "target_lang": "ja"}' \
          -w "\n%{http_code}")

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)

        echo "HTTP Status: $HTTP_CODE"
        echo "Response: $BODY"

        if [ "$HTTP_CODE" = "200" ]; then
          SUCCESS=$(echo "$BODY" | grep -o '"success":[^,}]*' | cut -d':' -f2)
          if [ "$SUCCESS" = "true" ]; then
            TRANSLATION=$(echo "$BODY" | grep -o '"translation":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… Translation successful: Hello world â†’ $TRANSLATION"
          else
            echo "âŒ Translation returned success=false"
            exit 1
          fi
        else
          echo "âŒ Translation test failed with HTTP $HTTP_CODE"
          exit 1
        fi

  staging:test:upload:
    desc: "Test PDF upload with test.pdf"
    cmds:
      - |
        STAGING_URL=$(gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -z "$STAGING_URL" ]; then
          echo "âŒ Staging service not found. Deploy first with: task staging:deploy"
          exit 1
        fi

        echo "ðŸ“„ Testing PDF upload to: $STAGING_URL"

        # Check if test.pdf exists
        if [ ! -f "frontend/public/test.pdf" ]; then
          echo "âŒ test.pdf not found in frontend/public/"
          exit 1
        fi

        # Test health endpoint first
        echo "ðŸ” Testing health endpoint..."
        curl -f "$STAGING_URL/api/health" || (echo "âŒ Health check failed" && exit 1)

        # Test PDF upload with correct endpoint
        echo "ðŸ“¤ Uploading test.pdf..."
        RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/upload_response.json -X POST "$STAGING_URL/api/analyze-pdf-json" \
          -F "file=@frontend/public/test.pdf" \
          -F "session_id=test-session-$(date +%s)" \
          -F "lang=ja")

        echo "HTTP Status: $RESPONSE"
        echo "Response:"
        cat /tmp/upload_response.json

        # Check if upload was successful (HTTP 200)
        if [ "$RESPONSE" = "200" ]; then
          TASK_ID=$(cat /tmp/upload_response.json | grep -o '"task_id":"[^"]*"' | cut -d'"' -f4)
          if [ -n "$TASK_ID" ]; then
            echo "âœ… PDF upload successful! Task ID: $TASK_ID"
            echo "ðŸ”„ Stream URL: $STAGING_URL/api/stream/$TASK_ID"
          else
            echo "âš ï¸ Upload response missing task_id"
          fi
        else
          echo "âŒ PDF upload failed with HTTP $RESPONSE"
          exit 1
        fi

  staging:health:
    desc: "Check staging services health"
    cmds:
      - echo "ðŸ” Checking staging services health..."
      - |
        # Check Backend
        BACKEND_URL=$(gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -n "$BACKEND_URL" ]; then
          echo "Backend: $BACKEND_URL"
          if curl -f -s "$BACKEND_URL/api/health" > /dev/null 2>&1; then
            echo "âœ… Backend healthy"
          else
            echo "âŒ Backend unhealthy"
          fi
        else
          echo "âš ï¸ Backend not deployed"
        fi

        # Check Inference Service
        INFERENCE_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -n "$INFERENCE_URL" ]; then
          echo "Inference: $INFERENCE_URL"
          if curl -f -s "$INFERENCE_URL/health" > /dev/null 2>&1; then
            echo "âœ… Inference service healthy"
          else
            echo "âŒ Inference service unhealthy"
          fi
        else
          echo "âš ï¸ Inference service not deployed"
        fi

  staging:logs:
    desc: "Show combined staging logs"
    cmds:
      - echo "ðŸ“‹ Staging combined logs (last 50 entries):"
      - gcloud run services logs read paperterrace-staging --limit=50 --region {{.REGION}} --format="table(receiveTimestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)"

  staging:logs:servicea:
    desc: "Show backend logs (Service A)"
    cmds:
      - echo "ðŸ“‹ Backend logs (last 50 entries) -> logs/servicea.log"
      - mkdir -p logs
      - gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace-staging"' --limit=50 --format="table(timestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)" | tee -a logs/servicea.log

  staging:logs:serviceb:
    desc: "Show inference service logs (Service B)"
    cmds:
      - echo "ðŸ“‹ Inference service logs (last 50 entries) -> logs/serviceb.log"
      - mkdir -p logs
      - gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace-inference-staging"' --limit=50 --format="table(timestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)" | tee -a logs/serviceb.log

  staging:logs:tail:servicea:
    desc: "Tail backend logs in real-time"
    cmds:
      - echo "ðŸ“‹ Tailing backend logs (Ctrl+C to stop)..."
      - gcloud logging tail 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace-staging"' --format="table(timestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)"

  staging:logs:tail:serviceb:
    desc: "Tail inference service logs in real-time"
    cmds:
      - echo "ðŸ“‹ Tailing inference service logs (Ctrl+C to stop)..."
      - gcloud logging tail 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace-inference-staging"' --format="table(timestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)"

  staging:logs:errors:
    desc: "Show only error logs from staging"
    cmds:
      - echo "ðŸ”´ Error logs from staging:"
      - gcloud logging read 'resource.type="cloud_run_revision"\
        AND (resource.labels.service_name="paperterrace-staging"\
        OR resource.labels.service_name="paperterrace-inference-staging")\
        AND severity>=ERROR' \
        --limit=20 --format="table(timestamp.date(tz='Asia/Tokyo'):label=TIME, \
        resource.labels.service_name:label=SERVICE, severity, textPayload, \
        jsonPayload.event:label=MESSAGE)" --order=asc

  staging:urls:
    desc: "Show staging service URLs"
    cmds:
      - echo "ðŸ”— Staging Service URLs:"
      - |
        BACKEND_URL=$(gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        INFERENCE_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)

        if [ -n "$BACKEND_URL" ]; then
          echo "Backend: $BACKEND_URL"
        else
          echo "Backend: Not deployed"
        fi

        if [ -n "$INFERENCE_URL" ]; then
          echo "Inference: $INFERENCE_URL"
        else
          echo "Inference: Not deployed"
        fi

  staging:stop:
    desc: "Stop staging services"
    cmds:
      - echo "ðŸ›‘ Stopping staging services..."
      - gcloud run services delete paperterrace-staging --region {{.REGION}} --quiet 2>/dev/null || echo "Backend already stopped"
      - gcloud run services delete paperterrace-inference-staging --region {{.REGION}} --quiet 2>/dev/null || echo "Inference service already stopped"
      - echo "âœ… Staging services stopped!"

  # ============================================================================
  # Monitoring & Logs
  # ============================================================================

  logs:prod:
    desc: "Show production logs"
    cmds:
      - echo "ðŸ“‹ Production combined logs (last 100 entries):"
      - gcloud run services logs read paperterrace --limit=100 --region {{.REGION}} --format="table(receiveTimestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)"

  logs:prod:tail:
    desc: "Tail production logs"
    cmds:
      - echo "ðŸ“‹ Tailing production logs (Ctrl+C to stop)..."
      - gcloud run services logs tail paperterrace --region {{.REGION}} --format="table(receiveTimestamp.date(tz='Asia/Tokyo'):label=TIME, severity, textPayload, jsonPayload.event:label=MESSAGE)"

  logs:errors:
    desc: "Show error logs"
    cmds:
      - gcloud logging read 'resource.type="cloud_run_revision" AND severity>=ERROR' --limit=50 --format="table(timestamp,severity,resource.labels.service_name,textPayload)" 2>/dev/null || echo "No error logs found"

  # ============================================================================
  # Utility Tasks
  # ============================================================================

  iam:add:
    desc: "Add public access to production service"
    cmds:
      - gcloud run services add-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  iam:remove:
    desc: "Remove public access from production service"
    cmds:
      - gcloud run services remove-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  cleanup:
    desc: "Clean up unused Docker images and containers"
    cmds:
      - echo "ðŸ§¹ Cleaning up Docker resources..."
      - docker system prune -f
      - echo "âœ… Docker cleanup complete!"
