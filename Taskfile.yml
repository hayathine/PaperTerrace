# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

dotenv: [".env"]

vars:
  PROJECT_ID: gen-lang-client-0800253336
  REGION: asia-northeast1

tasks:
  # ============================================================================
  # Development Tasks
  # ============================================================================
  
  default:
    desc: "Show available tasks"
    cmds:
      - task --list
    silent: true

  setup:
    desc: "Setup development environment"
    cmds:
      - echo "ðŸ”§ Setting up development environment..."
      - task: redis
      - echo "âœ… Development environment ready!"

  redis:
    desc: "Start Redis container for local development"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redis

  run:
    desc: "Run backend server with hot reload"
    cmds:
      - PYTHONUNBUFFERED=1 uv run --directory backend uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

  dev:
    desc: "Run frontend dev server"
    cmds:
      - npm run dev
    dir: frontend

  dev:full:
    desc: "Run both backend and frontend in parallel"
    deps: [redis]
    cmds:
      - echo "ðŸš€ Starting full development environment..."
      - |
        # Start backend in background
        PYTHONUNBUFFERED=1 uv run --directory backend uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &
        BACKEND_PID=$!
        
        # Start frontend in background  
        cd frontend && npm run dev &
        FRONTEND_PID=$!
        
        echo "Backend PID: $BACKEND_PID"
        echo "Frontend PID: $FRONTEND_PID"
        echo "Press Ctrl+C to stop both services"
        
        # Wait for interrupt
        trap "kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; exit" INT
        wait

  build:
    desc: "Build frontend for production"
    cmds:
      - npm run build
    dir: frontend

  test:
    desc: "Run backend tests"
    cmds:
      - uv run --directory backend pytest

  lint:
    desc: "Run linting and formatting"
    cmds:
      - echo "ðŸ” Running backend linting..."
      - uv run --directory backend ruff check --fix .
      - echo "ðŸ” Running frontend linting..."
      - cd frontend && npm run lint

  clean:
    desc: "Clean cache and temporary files"
    cmds:
      - echo "ðŸ§¹ Cleaning cache..."
      - rm -rf backend/.ruff_cache backend/__pycache__ backend/app/__pycache__
      - rm -rf frontend/node_modules/.cache frontend/dist
      - sqlite3 ocr_reader.db "DELETE FROM ocr_reader;" 2>/dev/null || true
      - rm -rf backend/app/static/paper_images/* 2>/dev/null || true
      - echo "âœ… Cache cleared!"

  # ============================================================================
  # Production Tasks
  # ============================================================================

  deploy:
    desc: "Deploy to production"
    cmds:
      - echo "ðŸš€ Deploying to production..."
      - ./scripts/deployment/deploy.sh

  deploy:fast:
    desc: "Fast deploy (skip infrastructure checks)"
    cmds:
      - ./scripts/deployment/deploy.sh --skip-infra

  # ============================================================================
  # Database Tasks
  # ============================================================================

  db:start:
    desc: "Start Cloud SQL instance"
    cmds:
      - echo "ðŸ”„ Starting Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS
      - task: db:wait

  db:stop:
    desc: "Stop Cloud SQL instance (save cost)"
    cmds:
      - echo "â¹ï¸ Stopping Cloud SQL instance..."
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER

  db:wait:
    desc: "Wait for Cloud SQL to be ready"
    cmds:
      - |
        echo "â³ Waiting for Cloud SQL to be RUNNABLE..."
        for i in {1..6}; do
          STATUS=$(gcloud sql instances describe paperterrace-db --format="value(state)")
          echo "Current state: $STATUS"
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "âœ… Cloud SQL is ready"
            exit 0
          fi
          sleep 30
        done
        echo "âŒ Cloud SQL did not become RUNNABLE"
        exit 1

  db:migrate:
    desc: "Run database migrations"
    cmds:
      - echo "ðŸ”„ Running database migrations..."
      - uv run --directory backend alembic upgrade head

  # ============================================================================
  # Staging Environment Tasks
  # ============================================================================

  staging:deploy:
    desc: "Deploy to staging environment"
    cmds:
      - echo "ðŸš€ Deploying to staging..."
      - docker build -f backend/Dockerfile -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging .
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging
      - |
        gcloud run deploy paperterrace-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:staging \
          --region {{.REGION}} \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 2 \
          --min-instances 0 \
          --max-instances 10 \
          --timeout 300 \
          --set-env-vars "GEMINI_API_KEY=${GEMINI_API_KEY},AI_PROVIDER=gemini,OCR_MODEL=gemini-1.5-flash"
      - echo "âœ… Staging deployed!"

  staging:deploy:microservices:
    desc: "Deploy microservices to staging"
    cmds:
      - task: staging:serviceb:deploy
      - task: staging:servicea:deploy
      - echo "ðŸŽ‰ Microservices deployed to staging!"
      - task: staging:urls

  staging:serviceb:deploy:
    desc: "Deploy inference service to staging"
    cmds:
      - echo "ðŸ”¨ Building and deploying ServiceB..."
      - docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging .
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging
      - |
        gcloud run deploy paperterrace-inference-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging \
          --region {{.REGION}} \
          --allow-unauthenticated \
          --memory 4Gi \
          --cpu 4 \
          --min-instances 1 \
          --max-instances 5 \
          --concurrency 10 \
          --timeout 300
      - echo "âœ… ServiceB deployed!"
    dir: inference-service

  staging:servicea:deploy:
    desc: "Deploy main service to staging"
    cmds:
      - echo "ðŸ”¨ Building and deploying ServiceA..."
      - docker build -f backend/Dockerfile -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging .
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null || echo "")
        gcloud run deploy paperterrace-main-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging \
          --region {{.REGION}} \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 2 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 80 \
          --timeout 300 \
          --set-env-vars "INFERENCE_SERVICE_URL=$SERVICEB_URL"
      - echo "âœ… ServiceA deployed!"

  staging:test:
    desc: "Run comprehensive staging tests"
    cmds:
      - echo "ðŸ§ª Running staging tests..."
      - task: staging:health
      - task: staging:test:upload
      - echo "âœ… All staging tests passed!"

  staging:test:upload:
    desc: "Test PDF upload with test.pdf"
    cmds:
      - |
        STAGING_URL=$(gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -z "$STAGING_URL" ]; then
          echo "âŒ Staging service not found. Deploy first with: task staging:deploy"
          exit 1
        fi
        
        echo "ðŸ“„ Testing PDF upload to: $STAGING_URL"
        
        # Check if test.pdf exists
        if [ ! -f "frontend/public/test.pdf" ]; then
          echo "âŒ test.pdf not found in frontend/public/"
          exit 1
        fi
        
        # Test health endpoint first
        echo "ðŸ” Testing health endpoint..."
        curl -f "$STAGING_URL/api/health" || (echo "âŒ Health check failed" && exit 1)
        
        # Test PDF upload with correct endpoint
        echo "ðŸ“¤ Uploading test.pdf..."
        RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/upload_response.json -X POST "$STAGING_URL/api/analyze-pdf-json" \
          -F "file=@frontend/public/test.pdf" \
          -F "session_id=test-session-$(date +%s)" \
          -F "lang=ja")
        
        echo "HTTP Status: $RESPONSE"
        echo "Response:"
        cat /tmp/upload_response.json
        
        # Check if upload was successful (HTTP 200)
        if [ "$RESPONSE" = "200" ]; then
          TASK_ID=$(cat /tmp/upload_response.json | grep -o '"task_id":"[^"]*"' | cut -d'"' -f4)
          if [ -n "$TASK_ID" ]; then
            echo "âœ… PDF upload successful! Task ID: $TASK_ID"
            echo "ðŸ”„ Stream URL: $STAGING_URL/api/stream/$TASK_ID"
          else
            echo "âš ï¸ Upload response missing task_id"
          fi
        else
          echo "âŒ PDF upload failed with HTTP $RESPONSE"
          exit 1
        fi

  staging:health:
    desc: "Check staging services health"
    cmds:
      - echo "ðŸ” Checking staging services health..."
      - |
        # Check ServiceA (main)
        SERVICEA_URL=$(gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -n "$SERVICEA_URL" ]; then
          echo "ServiceA: $SERVICEA_URL"
          curl -f "$SERVICEA_URL/api/health" && echo "âœ… ServiceA healthy" || echo "âŒ ServiceA unhealthy"
        else
          echo "âš ï¸ ServiceA not deployed"
        fi
        
        # Check ServiceB (inference)
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        if [ -n "$SERVICEB_URL" ]; then
          echo "ServiceB: $SERVICEB_URL"
          curl -f "$SERVICEB_URL/health" && echo "âœ… ServiceB healthy" || echo "âŒ ServiceB unhealthy"
        else
          echo "âš ï¸ ServiceB not deployed"
        fi

  staging:logs:
    desc: "Show staging logs"
    cmds:
      - echo "ðŸ“‹ Staging logs (last 50 entries):"
      - gcloud run services logs read paperterrace-main-staging --limit=50 --region {{.REGION}} 2>/dev/null || echo "No ServiceA logs found"

  staging:urls:
    desc: "Show staging service URLs"
    cmds:
      - echo "ðŸ”— Staging Service URLs:"
      - |
        SERVICEA_URL=$(gcloud run services describe paperterrace-main-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null)
        
        if [ -n "$SERVICEA_URL" ]; then
          echo "ServiceA (Main): $SERVICEA_URL"
        else
          echo "ServiceA: Not deployed"
        fi
        
        if [ -n "$SERVICEB_URL" ]; then
          echo "ServiceB (Inference): $SERVICEB_URL"
        else
          echo "ServiceB: Not deployed"
        fi

  staging:stop:
    desc: "Stop staging services"
    cmds:
      - echo "ðŸ›‘ Stopping staging services..."
      - gcloud run services delete paperterrace-main-staging --region {{.REGION}} --quiet 2>/dev/null || echo "ServiceA already stopped"
      - gcloud run services delete paperterrace-inference-staging --region {{.REGION}} --quiet 2>/dev/null || echo "ServiceB already stopped"
      - echo "âœ… Staging services stopped!"

  # ============================================================================
  # Monitoring & Logs
  # ============================================================================

  logs:prod:
    desc: "Show production logs"
    cmds:
      - gcloud run services logs read paperterrace --limit=100 --region {{.REGION}}

  logs:prod:tail:
    desc: "Tail production logs"
    cmds:
      - gcloud run services logs tail paperterrace --region {{.REGION}}

  logs:errors:
    desc: "Show error logs"
    cmds:
      - gcloud logging read 'resource.type="cloud_run_revision" AND severity>=ERROR' --limit=50 --format=json

  # ============================================================================
  # Utility Tasks
  # ============================================================================

  iam:add:
    desc: "Add public access to production service"
    cmds:
      - gcloud run services add-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  iam:remove:
    desc: "Remove public access from production service"
    cmds:
      - gcloud run services remove-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  cleanup:
    desc: "Clean up unused Docker images and containers"
    cmds:
      - echo "ðŸ§¹ Cleaning up Docker resources..."
      - docker system prune -f
      - echo "âœ… Docker cleanup complete!"
