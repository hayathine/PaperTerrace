# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

vars:
  GREETING: Hello, world!

tasks:
  default:
    desc: Print a greeting message
    cmds:
      - echo "{{.GREETING}}"
    silent: true

  redis:
    desc: "Start Redis container"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redisU

  run:
    desc: "Run local server"
    cmds:
      - uv run uvicorn src.main:app --reload

  build:
    desc: "Build frontend"
    cmds:
      - cd frontend && npm run dev

  read:
    desc: "Run local server"
    cmds:
      - gcloud run services logs read paperterrace --limit=1000
  
  tail:
    desc: "Run local server"
    cmds:
      - gcloud beta run services logs tail paperterrace

  get_iam:
    desc: "Get IAM policy"
    cmds:
      - gcloud run services get-iam-policy paperterrace

  add_all_users:
    desc: "Add auth"
    cmds:
      - gcloud run services add-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"


  remove_all_users:
    desc: "Remove IAM policy"
    cmds:
      - gcloud run services remove-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  db:stop:
    desc: Stop Cloud SQL instance (save cost)
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER
      
  db:start:
    desc: Start Cloud SQL instance
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS