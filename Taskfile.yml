# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

dotenv: [".env"]

vars:
  GREETING: Hello, world!
  PROJECT_ID: gen-lang-client-0800253336
  REGION: asia-northeast1

tasks:
  default:
    desc: Print a greeting message
    cmds:
      - echo "{{.GREETING}}"
    silent: true

  redis:
    desc: "Start Redis container"
    cmds:
      - docker run -d --name paper-terrace-redis -p 6379:6379 redis:latest || docker start paper-terrace-redis

  run:
    desc: "Run local server"
    cmds:
      - PYTHONUNBUFFERED=1 uv run uvicorn src.main:app 2>&1 | tee logs/server.log

  build:
    desc: "Build frontend"
    cmds:
      - cd frontend && npm run build

  dev:
    desc: "Run frontend dev server"
    cmds:
      - cd frontend && npm run dev

  read:info:
    desc: "Run local server"
    cmds:
      - gcloud run services logs read paperterrace --limit=100

  read:error:
    desc: "Run local server"
    cmds:
      - gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace" AND severity>=ERROR' --limit=50 --format=json

  tail:info:
    desc: "Run local server"
    cmds:
      - gcloud beta run services logs tail paperterrace

  tail:error:
    desc: "Run local server"
    cmds:
      - gcloud logging tail 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace" AND severity>=ERROR' --limit=50 --format=json

  get_iam:
    desc: "Get IAM policy"
    cmds:
      - gcloud run services get-iam-policy paperterrace

  add_all_users:
    desc: "Add auth"
    cmds:
      - gcloud run services add-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  remove_all_users:
    desc: "Remove IAM policy"
    cmds:
      - gcloud run services remove-iam-policy-binding paperterrace --member="allUsers" --role="roles/run.invoker"

  db:stop:
    desc: Stop Cloud SQL instance (save cost)
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=NEVER

  db:start:
    desc: Start Cloud SQL instance
    cmds:
      - gcloud sql instances patch paperterrace-db --activation-policy=ALWAYS

  all_stop:
    desc: Stop all services
    deps: [remove_all_users, db:stop]

  deploy:
    desc: Full deploy including infra checks
    cmds:
      - ./deploy.sh
  deploy:fast:
    desc: Deploy application code fast (skips infra checks)
    cmds:
      - ./deploy.sh --skip-infra

  db:wait:
    desc: Wait for Cloud SQL to be RUNNABLE
    cmds:
      - |
        echo "Waiting for Cloud SQL to be RUNNABLE..."
        for i in 1 2 3 4 5 6; do
          STATUS=$(gcloud sql instances describe paperterrace-db \
            --format="value(state)")
          echo "Current state: $STATUS"
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "Cloud SQL is ready"
            exit 0
          fi
          sleep 30
        done
        echo "Cloud SQL did not become RUNNABLE"
        exit 1

  start:
    desc: start db and deploy
    deps:
      - db:start
      - db:wait
      - deploy

  ruff:
    desc: "Run ruff"
    cmds:
      - uv run ruff check --fix .

  cache_clear:
    desc: "Clear cache"
    cmds:
      - sqlite3 ocr_reader.db "DELETE FROM ocr_reader;"
      - rm -rf src/static/paper_images/*

  # ============================================================================
  # Staging Environment Tasks (Microservice Architecture)
  # ============================================================================

  staging:serviceb:build:
    desc: "Build ServiceB (Inference Service) for staging"
    cmds:
      - echo "ğŸ”¨ Building ServiceB Image..."
      - cd inference-service && docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging .
      - echo "ğŸ“¤ Pushing ServiceB Image..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging
      - echo "âœ… ServiceB image built and pushed!"

  staging:serviceb:deploy:
    desc: "Deploy ServiceB (Inference Service) to staging"
    deps: [staging:serviceb:build]
    cmds:
      - echo "ğŸš€ Deploying ServiceB to staging..."
      - |
        gcloud run deploy paperterrace-inference-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/inference:staging \
          --region {{.REGION}} \
          --platform managed \
          --allow-unauthenticated \
          --memory 4Gi \
          --cpu 4 \
          --min-instances 1 \
          --max-instances 5 \
          --concurrency 10 \
          --no-cpu-throttling \
          --set-env-vars "ORT_INTRA_THREADS=4,ORT_INTER_THREADS=2,CT2_INTER_THREADS=1,CT2_INTRA_THREADS=4,LOG_LEVEL=INFO" \
          --timeout 300 \
          --execution-environment gen2
      - echo "âœ… ServiceB deployed to staging!"

  staging:servicea:build:
    desc: "Build ServiceA (Main Service) for staging"
    cmds:
      - echo "ğŸ”¨ Building ServiceA Image..."
      - docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging .
      - echo "ğŸ“¤ Pushing ServiceA Image..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging
      - echo "âœ… ServiceA image built and pushed!"

  staging:servicea:deploy:
    desc: "Deploy ServiceA (Main Service) to staging"
    deps: [staging:servicea:build]
    cmds:
      - echo "ğŸ” Getting ServiceB URL..."
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)")
        echo "ServiceB URL: $SERVICEB_URL"
        echo "ğŸš€ Deploying ServiceA to staging..."
        gcloud run deploy paperterrace-main-staging \
          --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/main:staging \
          --region {{.REGION}} \
          --platform managed \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 2 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 80 \
          --no-cpu-throttling \
          --set-env-vars "INFERENCE_SERVICE_URL=$SERVICEB_URL,INFERENCE_SERVICE_TIMEOUT=30,INFERENCE_SERVICE_RETRIES=3" \
          --timeout 300 \
          --execution-environment gen2
      - echo "âœ… ServiceA deployed to staging!"

  staging:deploy:microservices:
    desc: "Deploy both ServiceA and ServiceB to staging"
    cmds:
      - task: staging:serviceb:deploy
      - task: staging:servicea:deploy
      - echo "ğŸ‰ Microservices deployed to staging!"
      - echo "ServiceA URL:" && gcloud run services describe paperterrace-main-staging --region {{.REGION}} --format="value(status.url)"
      - echo "ServiceB URL:" && gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)"

  staging:health:
    desc: "Check health of staging services"
    cmds:
      - echo "ğŸ” Checking ServiceB health..."
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)")
        curl -f "$SERVICEB_URL/health" || echo "âŒ ServiceB health check failed"
      - echo "ğŸ” Checking ServiceA health..."
      - |
        SERVICEA_URL=$(gcloud run services describe paperterrace-main-staging --region {{.REGION}} --format="value(status.url)")
        curl -f "$SERVICEA_URL/" || echo "âŒ ServiceA health check failed"

  staging:logs:servicea:
    desc: "Read ServiceA staging logs"
    cmds:
      - gcloud run services logs read paperterrace-staging --limit=50 --project {{.PROJECT_ID}} --region {{.REGION}}

  staging:logs:serviceb:
    desc: "Read ServiceB staging logs"
    cmds:
      - gcloud run services logs read paperterrace-inference-staging --limit=50 --project {{.PROJECT_ID}} --region {{.REGION}}

  staging:logs:tail:servicea:
    desc: "Tail ServiceA staging logs"
    cmds:
      - gcloud run services logs tail paperterrace-staging --project {{.PROJECT_ID}} --region {{.REGION}}

  staging:logs:tail:serviceb:
    desc: "Tail ServiceB staging logs"
    cmds:
      - gcloud run services logs tail paperterrace-inference-staging --project {{.PROJECT_ID}} --region {{.REGION}}

  staging:test:translation:
    desc: "Test ServiceB translation endpoint"
    cmds:
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)")
        echo "Testing translation endpoint..."
        curl -X POST "$SERVICEB_URL/api/v1/translate" \
          -H "Content-Type: application/json" \
          -d '{"text": "Hello world", "source_lang": "en", "target_lang": "ja"}' \
          | jq .

  staging:test:layout:
    desc: "Test ServiceB layout analysis endpoint"
    cmds:
      - |
        SERVICEB_URL=$(gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)")
        echo "Testing layout analysis endpoint..."
        curl -X POST "$SERVICEB_URL/api/v1/layout-analysis" \
          -H "Content-Type: application/json" \
          -d '{"pdf_path": "test.pdf", "pages": [1]}' \
          | jq .

  staging:stop:
    desc: "Stop staging microservices"
    cmds:
      - echo "ğŸ›‘ Stopping ServiceA..."
      - gcloud run services delete paperterrace-main-staging --region {{.REGION}} --quiet || echo "ServiceA not found"
      - echo "ğŸ›‘ Stopping ServiceB..."
      - gcloud run services delete paperterrace-inference-staging --region {{.REGION}} --quiet || echo "ServiceB not found"
      - echo "âœ… Staging microservices stopped!"

  staging:test:all:
    desc: "Run comprehensive staging tests"
    cmds:
      - ./scripts/staging-test.sh

  staging:test:load:
    desc: "Run staging tests with load testing"
    cmds:
      - ./scripts/staging-test.sh --load-test

  staging:urls:
    desc: "Get staging service URLs"
    cmds:
      - echo "ServiceA URL:"
      - gcloud run services describe paperterrace-main-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null || echo "ServiceA not deployed"
      - echo "ServiceB URL:"
      - gcloud run services describe paperterrace-inference-staging --region {{.REGION}} --format="value(status.url)" 2>/dev/null || echo "ServiceB not deployed"

  # Legacy staging tasks (keeping for backward compatibility)
  staging:build:
    desc: "Build and push staging image (no deploy)"
    cmds:
      - echo "ğŸ”¨ Building Image Locally..."
      - docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest .
      - echo "ğŸ“¤ Pushing Image to Artifact Registry..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest
      - echo "âœ… Image pushed successfully!"

  staging:deploy:
    desc: "Deploy to Staging (build + push + deploy, skips Terraform for speed)"
    cmds:
      - echo "ğŸ”¨ 1. Building Image Locally (using cache)..."
      - docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest .
      - echo "ğŸ“¤ 2. Pushing Image to Artifact Registry..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest
      - echo "ğŸš€ 3. Deploying to Cloud Run..."
      - gcloud run deploy paperterrace-staging --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest --region {{.REGION}} --allow-unauthenticated
      - echo "âœ… Staging deployed!"

  staging:deploy:full:
    desc: "Full Staging deploy (includes Terraform infrastructure update)"
    cmds:
      - echo "ğŸ”¨ 1. Building Image Locally..."
      - docker build -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest .
      - echo "ğŸ“¤ 2. Pushing Image to Artifact Registry..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest
      - echo "ğŸ—ï¸ 3. Applying Terraform Infrastructure..."
      - cd terraform && TF_VAR_gemini_api_key=$GEMINI_API_KEY TF_VAR_db_password=$DB_PASSWORD terraform apply -var="enable_staging=true" -auto-approve
      - echo "ğŸš€ 4. Deploying to Cloud Run..."
      - gcloud run deploy paperterrace-staging --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest --region {{.REGION}} --allow-unauthenticated
      - echo "âœ… Full staging deploy complete!"

  staging:rebuild:
    desc: "Force rebuild without cache and deploy"
    cmds:
      - echo "ğŸ”¨ Building Image (NO CACHE)..."
      - docker build --no-cache -t {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest .
      - echo "ğŸ“¤ Pushing Image to Artifact Registry..."
      - docker push {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest
      - echo "ğŸš€ Deploying to Cloud Run..."
      - gcloud run deploy paperterrace-staging --image {{.REGION}}-docker.pkg.dev/{{.PROJECT_ID}}/paperterrace/app:latest --region {{.REGION}} --allow-unauthenticated
      - echo "âœ… Staging rebuilt and deployed!"

  staging:logs:
    desc: "Read Staging logs (App logs only, JST)"
    cmds:
      - |
        gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="paperterrace-staging" AND jsonPayload.logger:*' \
          --project={{.PROJECT_ID}} \
          --limit=50 \
          --format="table(jsonPayload.timestamp.date('%Y-%m-%d %H:%M:%S'),jsonPayload.level,jsonPayload.event)"

  staging:logs:all:
    desc: "Read all Staging logs (including system logs)"
    cmds:
      - gcloud run services logs read paperterrace-staging --limit=50 --project {{.PROJECT_ID}} --region {{.REGION}}

  staging:url:
    desc: "Get Staging URL"
    cmds:
      - gcloud run services describe paperterrace-staging --region {{.REGION}} --format="value(status.url)"

  clear-images:
    desc: "====CAUTION==== Clear all images from GCS bucket"
    cmds:
      - gcloud storage rm gs://gen-lang-client-0800253336_cloudbuild/source/** --project={{.PROJECT_ID}}
