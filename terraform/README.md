# PaperTerrace ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€PaperTerraceã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Google Cloud Platform (GCP) ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
3. [åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
4. [GitHub Actions ã®è¨­å®š](#github-actions-ã®è¨­å®š)
5. [ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•](#ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•)
6. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
7. [ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤](#ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤)

---

## å‰ææ¡ä»¶

### å¿…è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ„ãƒ¼ãƒ«

| é …ç›® | èª¬æ˜ | å…¥æ‰‹æ–¹æ³• |
|------|------|----------|
| **GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ** | `paperterrace` (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç•ªå·: 316073929194) | [GCP Console](https://console.cloud.google.com) |
| **gcloud CLI** | GCPãƒªã‚½ãƒ¼ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« | [ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰](https://cloud.google.com/sdk/docs/install) |
| **Terraform** | ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.5.0ä»¥ä¸Šï¼‰ | [ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://www.terraform.io/downloads) |
| **GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** | CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œã«å¿…è¦ | [GitHub](https://github.com) |

### gcloud CLI ã®åˆæœŸè¨­å®š

```bash
# GCPã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³
gcloud auth login

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š
gcloud config set project paperterrace

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼æƒ…å ±ã‚’è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
gcloud auth application-default login
```

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: paperterrace                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚    â”‚   ã‚¤ãƒ³ã‚¿ãƒ¼   â”‚                                                     â”‚
â”‚    â”‚   ãƒãƒƒãƒˆ     â”‚                                                     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚           â”‚                                                              â”‚
â”‚           â–¼                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚                    Cloud Run                          â”‚             â”‚
â”‚    â”‚                 (paperterrace)                        â”‚             â”‚
â”‚    â”‚                                                        â”‚             â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚
â”‚    â”‚  â”‚  FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³                       â”‚  â”‚             â”‚
â”‚    â”‚  â”‚  - PDFè§£æ (Gemini Vision)                     â”‚  â”‚             â”‚
â”‚    â”‚  â”‚  - AI ãƒãƒ£ãƒƒãƒˆãƒ»è¦ç´„æ©Ÿèƒ½                        â”‚  â”‚             â”‚
â”‚    â”‚  â”‚  - ç¿»è¨³ãƒ»æ‰¹åˆ¤çš„åˆ†æ                            â”‚  â”‚             â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â”‚ VPC Connector                             â”‚
â”‚                              â”‚ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶š)                         â”‚
â”‚                              â–¼                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚                    ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ VPC                          â”‚      â”‚
â”‚    â”‚                   (10.0.0.0/24)                              â”‚      â”‚
â”‚    â”‚                                                               â”‚      â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚
â”‚    â”‚   â”‚   Cloud SQL     â”‚     â”‚   VPC Connector             â”‚   â”‚      â”‚
â”‚    â”‚   â”‚  (PostgreSQL)   â”‚â—„â”€â”€â”€â”€â”‚   (10.8.0.0/28)             â”‚   â”‚      â”‚
â”‚    â”‚   â”‚                 â”‚     â”‚                             â”‚   â”‚      â”‚
â”‚    â”‚   â”‚  - è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—â”‚     â”‚  Cloud Run ã¨ Cloud SQL ã‚’   â”‚   â”‚      â”‚
â”‚    â”‚   â”‚  - Point-in-timeâ”‚     â”‚  ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«æ¥ç¶š          â”‚   â”‚      â”‚
â”‚    â”‚   â”‚    ãƒªã‚«ãƒãƒª     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚                    ãã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹                          â”‚      â”‚
â”‚    â”‚                                                               â”‚      â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚    â”‚  â”‚ Artifact    â”‚  â”‚ Cloud       â”‚  â”‚ Secret Manager     â”‚  â”‚      â”‚
â”‚    â”‚  â”‚ Registry    â”‚  â”‚ Storage     â”‚  â”‚                    â”‚  â”‚      â”‚
â”‚    â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ - GEMINI_API_KEY   â”‚  â”‚      â”‚
â”‚    â”‚  â”‚ Docker      â”‚  â”‚ PDF ãƒ•ã‚¡ã‚¤ãƒ« â”‚  â”‚ - DB_PASSWORD      â”‚  â”‚      â”‚
â”‚    â”‚  â”‚ ã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜ â”‚  â”‚ ä¿å­˜        â”‚  â”‚                    â”‚  â”‚      â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ãƒªã‚½ãƒ¼ã‚¹ã®èª¬æ˜

| ãƒªã‚½ãƒ¼ã‚¹ | å½¹å‰² | è¨­å®šå†…å®¹ |
|----------|------|----------|
| **Cloud Run** | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œç’°å¢ƒ | min=0, max=10ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€CPUã‚¢ã‚¤ãƒ‰ãƒ«æ™‚èª²é‡‘ãªã— |
| **Cloud SQL** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆè«–æ–‡ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ¡ãƒ¢ä¿å­˜ï¼‰ | PostgreSQL 15, db-f1-micro, è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| **Cloud Storage** | PDFãƒ•ã‚¡ã‚¤ãƒ«ã®æ°¸ç¶šä¿å­˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹ã€365æ—¥å¾Œã«NEARLINEã¸ç§»è¡Œ |
| **Artifact Registry** | Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜ | æœ€æ–°10ä¸–ä»£ã‚’ä¿æŒã€30æ—¥ä»¥ä¸Šå¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å‰Šé™¤ |
| **Secret Manager** | æ©Ÿå¯†æƒ…å ±ã®å®‰å…¨ãªç®¡ç† | APIã‚­ãƒ¼ã€DBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æš—å·åŒ–ã—ã¦ä¿å­˜ |
| **VPC / VPC Connector** | ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | Cloud Run â†’ Cloud SQL ã®ã‚»ã‚­ãƒ¥ã‚¢ãªæ¥ç¶š |

---

## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚¹ãƒ†ãƒƒãƒ— 1: Terraform ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆã®ä½œæˆ

Terraformã®çŠ¶æ…‹ï¼ˆstateï¼‰ã‚’ãƒãƒ¼ãƒ é–“ã§å…±æœ‰ã—ã€å®‰å…¨ã«ç®¡ç†ã™ã‚‹ãŸã‚ã«Cloud Storageãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆã‚’ä½œæˆï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³: asia-northeast1 = æ±äº¬ï¼‰
gcloud storage buckets create gs://paperterrace-terraform-state \
  --project=paperterrace \
  --location=asia-northeast1

# ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆèª¤ã£ã¦ä¸Šæ›¸ãã—ãŸå ´åˆã®å¾©æ—§ç”¨ï¼‰
gcloud storage buckets update gs://paperterrace-terraform-state --versioning

# ç¢ºèª
gcloud storage ls --long gs://paperterrace-terraform-state
```

**ğŸ’¡ ãªãœã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆãŒå¿…è¦ï¼Ÿ**
- Terraformã¯ã‚¤ãƒ³ãƒ•ãƒ©ã®ç¾åœ¨çŠ¶æ…‹ã‚’ã€Œstateã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™
- ãƒãƒ¼ãƒ ã§ä½œæ¥­ã™ã‚‹å ´åˆã€ã“ã®stateã‚’å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- GCSã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°äººãŒåŒã˜ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ç®¡ç†ã§ãã¾ã™

---

### ã‚¹ãƒ†ãƒƒãƒ— 2: Workload Identity Federation ã®è¨­å®š

GitHub Actionsã‹ã‚‰GCPãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®èªè¨¼ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é•·æœŸçš„ãªã‚­ãƒ¼ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå‘ä¸Šã—ã¾ã™ã€‚

```bash
# ===== 2.1: Workload Identity Pool ã®ä½œæˆ =====
# GitHub Actionsã‹ã‚‰ã®èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆ
gcloud iam workload-identity-pools create "github-pool" \
  --project="paperterrace" \
  --location="global" \
  --display-name="GitHub Actions Pool"

# ===== 2.2: OIDC Provider ã®ä½œæˆ =====
# GitHubã®OIDCãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¨­å®š
gcloud iam workload-identity-pools providers create-oidc "github-provider" \
  --project="paperterrace" \
  --location="global" \
  --workload-identity-pool="github-pool" \
  --display-name="GitHub Actions Provider" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
  --issuer-uri="https://token.actions.githubusercontent.com"

# ===== 2.3: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ =====
# GitHub ActionsãŒä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
gcloud iam service-accounts create github-actions \
  --project="paperterrace" \
  --display-name="GitHub Actions Service Account"

# ===== 2.4: å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸ =====
# Editoræ¨©é™ï¼ˆã»ã¨ã‚“ã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆãƒ»ç®¡ç†å¯èƒ½ï¼‰
gcloud projects add-iam-policy-binding paperterrace \
  --member="serviceAccount:github-actions@paperterrace.iam.gserviceaccount.com" \
  --role="roles/editor"

# Secret Managerç®¡ç†æ¨©é™
gcloud projects add-iam-policy-binding paperterrace \
  --member="serviceAccount:github-actions@paperterrace.iam.gserviceaccount.com" \
  --role="roles/secretmanager.admin"

# IAMç®¡ç†æ¨©é™ï¼ˆWorkload Identityè¨­å®šã«å¿…è¦ï¼‰
gcloud projects add-iam-policy-binding paperterrace \
  --member="serviceAccount:github-actions@paperterrace.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountAdmin"

# ===== 2.5: GitHub ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®èªè¨¼ã‚’è¨±å¯ =====
# âš ï¸ é‡è¦: YOUR_GITHUB_ORG ã‚’å®Ÿéš›ã®GitHubçµ„ç¹”åã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã¦ãã ã•ã„
gcloud iam service-accounts add-iam-policy-binding \
  github-actions@paperterrace.iam.gserviceaccount.com \
  --project="paperterrace" \
  --role="roles/iam.workloadIdentityUser" \
  --member="principalSet://iam.googleapis.com/projects/316073929194/locations/global/workloadIdentityPools/github-pool/attribute.repository/YOUR_GITHUB_ORG/PaperTerrace"
```

**ğŸ’¡ Workload Identity Federation ã¨ã¯?**
- å¾“æ¥: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®JSONã‚­ãƒ¼ã‚’GitHub Secretsã«ä¿å­˜ï¼ˆæ¼æ´©ãƒªã‚¹ã‚¯ï¼‰
- æ–°æ–¹å¼: GitHubãŒç™ºè¡Œã™ã‚‹OIDCãƒˆãƒ¼ã‚¯ãƒ³ã§ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã‚’å–å¾—ï¼ˆã‚ˆã‚Šå®‰å…¨ï¼‰

---

## GitHub Actions ã®è¨­å®š

### ã‚¹ãƒ†ãƒƒãƒ— 3: GitHub Secrets ã®è¨­å®š

GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Actions ã§ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã™ï¼š

| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå | å€¤ | èª¬æ˜ |
|---------------|-----|------|
| `GCP_WORKLOAD_IDENTITY_PROVIDER` | `projects/316073929194/locations/global/workloadIdentityPools/github-pool/providers/github-provider` | Workload Identity ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ•ãƒ«ãƒ‘ã‚¹ |
| `GCP_SERVICE_ACCOUNT` | `github-actions@paperterrace.iam.gserviceaccount.com` | ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| `GEMINI_API_KEY` | ã‚ãªãŸã®Gemini APIã‚­ãƒ¼ | [Google AI Studio](https://aistudio.google.com/app/apikey) ã§å–å¾— |
| `DB_PASSWORD` | å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | Cloud SQLç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: `openssl rand -base64 32` ã§ç”Ÿæˆï¼‰ |

**è¨­å®šæ‰‹é †:**
1. GitHubãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. `Settings` ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® `Secrets and variables` â†’ `Actions` ã‚’é¸æŠ
4. `New repository secret` ã‚’ã‚¯ãƒªãƒƒã‚¯
5. å„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ 

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### æ–¹æ³• A: æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å®Ÿè¡Œï¼‰

é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆæ™‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
# Terraformãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd terraform

# ===== 1. åˆæœŸåŒ– =====
# Terraformãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
terraform init

# ===== 2. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª =====
# ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€
terraform fmt -recursive

# ===== 3. æ§‹æ–‡æ¤œè¨¼ =====
terraform validate

# ===== 4. å®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª =====
# ä½•ãŒä½œæˆ/å¤‰æ›´/å‰Šé™¤ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèª
# âš ï¸ å®Ÿéš›ã®APIã‚­ãƒ¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
terraform plan \
  -var="gemini_api_key=YOUR_GEMINI_API_KEY" \
  -var="db_password=YOUR_SECURE_PASSWORD"

# ===== 5. ã‚¤ãƒ³ãƒ•ãƒ©ã®ä½œæˆ =====
# ç¢ºèªå¾Œã€å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
terraform apply \
  -var="gemini_api_key=YOUR_GEMINI_API_KEY" \
  -var="db_password=YOUR_SECURE_PASSWORD"

# ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œyesã€ã¨å…¥åŠ›
```

### æ–¹æ³• B: CI/CDè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰

GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã ã‘ã§è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼:**

```
1. ã‚³ãƒ¼ãƒ‰ã‚’mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
        â†“
2. GitHub Actions ãŒèµ·å‹•
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  terraform.yml ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼                           â”‚
â”‚  â”œâ”€â”€ terraform fmt  ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼‰          â”‚
â”‚  â”œâ”€â”€ terraform init ï¼ˆåˆæœŸåŒ–ï¼‰                        â”‚
â”‚  â”œâ”€â”€ terraform validate ï¼ˆæ§‹æ–‡æ¤œè¨¼ï¼‰                  â”‚
â”‚  â”œâ”€â”€ terraform plan ï¼ˆå®Ÿè¡Œè¨ˆç”»ä½œæˆï¼‰                  â”‚
â”‚  â””â”€â”€ terraform apply ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©ä½œæˆãƒ»æ›´æ–°ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  deploy.yml ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼                              â”‚
â”‚  â”œâ”€â”€ uv sync ï¼ˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰                 â”‚
â”‚  â”œâ”€â”€ ruff check ï¼ˆã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼‰                   â”‚
â”‚  â”œâ”€â”€ pytest ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰                           â”‚
â”‚  â”œâ”€â”€ docker build ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼‰                  â”‚
â”‚  â”œâ”€â”€ docker push ï¼ˆArtifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥ï¼‰      â”‚
â”‚  â””â”€â”€ deploy cloudrun ï¼ˆCloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
3. æœ¬ç•ªç’°å¢ƒã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¬é–‹ã•ã‚Œã‚‹
   https://paperterrace-xxxxx.run.app
```

**Pull Requestæ™‚ã®å‹•ä½œ:**
- `terraform plan` ã®çµæœãŒPRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã•ã‚Œã¾ã™
- å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã§ãã¾ã™

---

## å‡ºåŠ›ã•ã‚Œã‚‹æƒ…å ±

`terraform apply` å®Œäº†å¾Œã€ä»¥ä¸‹ã®æƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼š

```bash
# å‡ºåŠ›ã‚’ç¢ºèª
terraform output
```

| å‡ºåŠ›å | èª¬æ˜ | ä¾‹ |
|--------|------|-----|
| `cloud_run_url` | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URL | `https://paperterrace-xxxx-an.a.run.app` |
| `artifact_registry_url` | Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜å…ˆ | `asia-northeast1-docker.pkg.dev/paperterrace/paperterrace` |
| `storage_bucket_name` | PDFãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒã‚±ãƒƒãƒˆ | `paperterrace-papers` |
| `cloud_sql_connection_name` | Cloud SQLæ¥ç¶šå | `paperterrace:asia-northeast1:paperterrace-db` |

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

#### 1. APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

```
Error: Error enabling service: googleapi: Error 403: 
Service Usage API has not been used in project...
```

**å¯¾å‡¦æ³•:**
```bash
# å¿…è¦ãªAPIã‚’æ‰‹å‹•ã§æœ‰åŠ¹åŒ–
gcloud services enable \
  run.googleapis.com \
  sqladmin.googleapis.com \
  secretmanager.googleapis.com \
  artifactregistry.googleapis.com \
  servicenetworking.googleapis.com \
  vpcaccess.googleapis.com
```

#### 2. æ¨©é™ã‚¨ãƒ©ãƒ¼

```
Error: Error creating Service: googleapi: Error 403: 
The caller does not have permission
```

**å¯¾å‡¦æ³•:**
ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¿…è¦ãªæ¨©é™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2.4å‚ç…§ï¼‰

#### 3. Terraformã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒ­ãƒƒã‚¯

```
Error: Error locking state: Error acquiring the state lock
```

**å¯¾å‡¦æ³•:**
```bash
# å¼·åˆ¶çš„ã«ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆä»–ã®äººãŒä½œæ¥­ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ï¼‰
terraform force-unlock LOCK_ID
```

#### 4. Cloud SQLæ¥ç¶šã‚¨ãƒ©ãƒ¼

```
Error: Cloud Run service could not start: 
Connection to Cloud SQL failed
```

**å¯¾å‡¦æ³•:**
- VPC ConnectorãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Cloud SQLã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

---

## ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤

**âš ï¸ æ³¨æ„: ã“ã®æ“ä½œã¯ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ï¼**

```bash
cd terraform

# å‰Šé™¤å‰ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
terraform state list

# å‰Šé™¤è¨ˆç”»ã‚’ç¢ºèª
terraform plan -destroy \
  -var="gemini_api_key=dummy" \
  -var="db_password=dummy"

# ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
terraform destroy \
  -var="gemini_api_key=dummy" \
  -var="db_password=dummy"

# ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œyesã€ã¨å…¥åŠ›
```

**å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹:**
- Cloud Run ã‚µãƒ¼ãƒ“ã‚¹
- Cloud SQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å«ã‚€ï¼‰
- Cloud Storage ãƒã‚±ãƒƒãƒˆï¼ˆä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å«ã‚€ï¼‰
- Artifact Registry ãƒªãƒã‚¸ãƒˆãƒª
- Secret Manager ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
- VPC / VPC Connector

---

## ğŸ’¡ ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ

| ãƒªã‚½ãƒ¼ã‚¹ | ç¯€ç´„æ–¹æ³• |
|----------|----------|
| Cloud Run | `min_instance_count = 0` ã§ä½¿ç”¨æ™‚ã®ã¿èª²é‡‘ |
| Cloud SQL | é–‹ç™ºæ™‚ã¯ `db-f1-micro`ã€æœ¬ç•ªã¯å¿…è¦ã«å¿œã˜ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ |
| Cloud Storage | ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã§å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½ã‚³ã‚¹ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç§»è¡Œ |

**æœˆé¡ã‚³ã‚¹ãƒˆç›®å®‰ï¼ˆä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ï¼‰:**
- Cloud Run: ã€œ$0ï¼ˆç„¡æ–™æ å†…ï¼‰
- Cloud SQL: ã€œ$10/æœˆï¼ˆdb-f1-microï¼‰
- Cloud Storage: ã€œ$1/æœˆï¼ˆæ•°GBç¨‹åº¦ï¼‰
- åˆè¨ˆ: ç´„ $10-15/æœˆ

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Terraform GCPãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
- [Cloud Run ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/run/docs)
- [Workload Identity Federation](https://cloud.google.com/iam/docs/workload-identity-federation)
- [GitHub Actions GCPãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/google-github-actions)
